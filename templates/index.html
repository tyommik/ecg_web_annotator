<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ECG Annotation Tool</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="/static/js/canvasjs.min.js"></script>

    <link rel="stylesheet" href="//cdn.webix.com/edge/webix.css" type="text/css">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>
</head>
<body>

<!--<div id="mainLayout" style='display:none;'>Select item from ECG list</div>-->

<script type="text/javascript" charset="utf-8">
    function sendRequest(method, url) {
        return fetch(url).then(response => {
            return response.json()
        })
    }

    var header = {
            id: "header",
            css: "header",
            template: "<div id='header'>EKG annotation tool</div>",
            height: 50
        }

    webix.ready(() => {
        webix.ui({
            rows: [
                header,
                {
                    cols: [
                        {
                            gravity: 3, rows: [
                                {
                                    id: "drawLayout",
                                    align: "center,middle",
                                    template:'<button class="btn-back" id="button" style="visibility:visible">&#8634;</button><div id="graph"></div>',
                                    width:0,
                                    // height:800,
                                    // rows: [],
                                },
                                {
                                    rows: [

                                        {
                                            view: "form",
                                            scroll: false,
                                            elements: [],
                                            id: "form_tipos",
                                            height: 300,
                                        },
                                        {
                                            margin: 5, cols: [
                                                {
                                                    id: "saveBtn",
                                                    view: "button",
                                                    label: "Save",
                                                    disabled: true,
                                                    type: "form",
                                                    click: () => {
                                                        var form = $$("form_tipos");
                                                        data = getForm(form);
                                                        if (data) {
                                                            // if (form.validate()) {
                                                            webix.ajax().post("/anno/100", data, function (res) {
                                                                webix.message('Saved')
                                                            });
                                                        }
                                                    }
                                                },
                                                {id: "cancelBtn", view: "button", disabled:true, label: "Cancel", click: () => {alert('Clean Stub')}}
                                            ]
                                        }

                                    ]
                                },
                            ]
                        },
                        {
                            // container: "ecglist",
                            rows: [
                                {
                                    cols: [
                                        {
                                            header: "Список ЭКГ", body:
                                                {
                                                    view: "list",
                                                    template: "#rank#. #title#",
                                                    url: "/getlist",
                                                    select: true,
                                                    on: {
                                                        // the default click behavior that is true for any datatable cell
                                                        "onItemClick": function (id, e, trg) {
                                                            requestData(id)
                                                        }
                                                    },
                                                }
                                        },

                                    ]
                                },
                                {
                                    id: "sendButton",
                                    view: "button",
                                    value: "Cancel",
                                    label: "Send"
                                },
                            ]
                        },
                    ]
                },
                {align: "center,middle", template: "<div id='footer'>Stream Labs 2020</div>", height: 50}
            ]
        })
    });

    function getForm(form) {
        var values = form.getChildViews()
        var response = []
        for (i = 0; i < values.length; i++) {
            var block = values[i].getValues()
            response.push(block)
        }
        return JSON.stringify(response)
    }

    function requestData(id) {
        $$("saveBtn").enable()
        $$("cancelBtn").enable()
        // requestLeadData(id)
        requestReportDate(id)
    }

    function requestReportDate(id) {
        const requestURL = '/anno/' + id
        sendRequest('GET', requestURL)
            .then(data => {
                rebuildForm(data)
            })
            .catch(err => {
                    webix.message(err)
                }
            )
    }

    function requestLeadData(id) {
        const requestURL = '/leads/' + id
        sendRequest('GET', requestURL)
            .then(data => {
                drawOnLayout(data)
                // drawLeads({"test": "here"}, d)
                // getData()
            })
            .catch(err => {
                    webix.message(err)
                }
            )
    }

    function rebuildForm(data, clean=false) {
        data = data.data
        let checkbox = []
        for (i = 0; i < data.length; i++) {
            let group = []
            group.push({ template:data[i]["group_label"], type:"section"})
            let group_array = data[i]["group_data"]
            for (j = 0; j < group_array.length; j++) {
                group.push({
                    view: "checkbox",
                    label: group_array[j].label,
                    name: group_array[j].name,
                    value: (clean) ? 0 : group_array[j].value,
                })
            }
            // checkbox.push({rows: group})
            checkbox.push({
                view: "form",
                elements: group,
                margin: 55,
                elementsConfig: {"labelAlign": "right"}
            })
        }
        webix.ui({
                view: "form",
                scroll: false,
                id: 'form_tipos',
                cols: checkbox
            }
            , $$('form_tipos'));
        // this.disable();
    }

    function drawOnLayout(data) {
        var graph = webix.$$('test')
        webix.html.remove(graph)
        webix.ui({
            id: 'test',
            align: "center,middle",
            // template:'<button class="btn-back" id="button" style="visibility:visible">&#8634;</button><div id="graph"></div>',
            body: {
                view: "label",
                label: "<div id='warnstyle'>Select item from list</div>",
                align: "center"
            }
        }, $$('drawLayout'));
    }

    function drawLeads() {

        var xAxisStripLinesArray = [];
        var yAxisStripLinesArray = [];
        var dps = [];
        var dataPointsArray = [1835, 1967, 1956, 1952, 1952, 1919, 1886, 1886, 1883, 1883, 1876, 1859, 1859, 1838, 1844, 1844, 1838, 1823, 1823, 1823, 1850, 1850, 1817, 1824, 1824, 1846, 1835, 1835, 1838, 1838, 1853, 1853, 1853, 1853, 1862, 1862, 1858, 1872, 1872, 1876, 1874, 1874, 1883, 1896, 1896, 1911, 1911, 1910, 1913, 1913, 1906, 1935, 1935, 1933, 1934, 1934, 1936, 1944, 1944, 1943, 1948, 1948, 1939, 1957, 1957, 1963, 1954, 1954, 1954, 1954, 1971, 1971, 1971, 1967, 1960, 1960, 1970, 1976, 1976, 1971, 1962, 1962, 1978, 1960, 1960, 1957, 1957, 1972, 1966, 1966, 1966, 1960, 1960, 1955, 1968, 1968, 1970, 1956, 1956, 1971, 1972, 1972, 1959, 1972, 1972, 1991, 1978, 1978, 1967, 1967, 1966, 1979, 1979, 1973, 1968, 1968, 1979, 1977, 1977, 1960, 1970, 1970, 1975, 1964, 1964, 1968, 1968, 1969, 1960, 1960, 1971, 1970, 1970, 1974, 1975, 1975, 1967, 1960, 1960, 1976, 1974, 1974, 1983, 1978, 1978, 1974, 1974, 1985, 1982, 1982, 1974, 1984, 1984, 1983, 1984, 1984, 1992, 1987, 1987, 1987, 1987, 1987, 1992, 1992, 1987, 1996, 1996, 1996, 1992, 1992, 1994, 1992, 1992, 2004, 2001, 2001, 2004, 1998, 1998, 1991, 2005, 2005, 2022, 2022, 2005, 2007, 2007, 2011, 2012, 2012, 2008, 2016, 2016, 2021, 2024, 2024, 2005, 2011, 2011, 2019, 2019, 2014, 2015, 2015, 2014, 1999, 1999, 2011, 2013, 2013, 1999, 2024, 2024, 2008, 1996, 1996, 2027, 2011, 2011, 2010, 2010, 2036, 2023, 2023, 2028, 2045, 2045, 2050, 2051, 2051, 2059, 2054, 2054, 2067, 2056, 2056, 2047, 2066, 2066, 2049, 2049, 2035, 2041, 2041, 2013, 2020, 2020, 2014, 1998, 1998, 1990, 1992, 1992, 1987, 1980, 1980, 1979, 1985, 1985, 1980, 1980, 1981, 1992, 1992, 1974, 1987, 1987, 1977, 1981, 1981, 1983, 1987, 1987, 2013, 2040, 2040, 2083, 2130, 2130, 2183, 2183, 2250, 2325, 2325, 2423, 2527, 2527, 2559, 2559, 2559, 2523, 2368, 2368, 2232, 2096, 2096, 2004, 2004, 1901, 1858, 1858, 1834, 1838, 1838, 1831, 1853, 1853, 1847, 1845, 1845, 1851, 1860, 1860, 1870, 1872, 1872, 1891, 1893, 1893, 1894, 1894, 1901, 1919, 1919, 1917, 1930, 1930, 1947, 1925, 1925, 1943, 1952, 1952, 1947, 1954, 1954, 1951, 1951, 1960, 1962, 1962, 1966, 1978, 1978, 1979, 1973, 1973, 1984, 1978, 1978, 1984, 1991, 1991, 1983, 1983, 1983, 1999, 1992, 1992, 1998, 1998, 1998, 2006, 2006, 1999, 2016, 2016, 2005, 2038, 2038, 2006, 2017, 2017, 2042, 2027, 2027, 2031, 2031, 2051, 2044, 2044, 2043, 2070, 2070, 2062, 2055, 2055, 2065, 2056, 2056, 2070, 2080, 2080, 2068, 2078, 2078, 2077, 2077, 2074, 2087, 2087, 2093, 2102, 2102, 2091, 2102, 2102, 2118, 2114, 2114, 2116, 2128, 2128, 2108, 2108, 2095, 2108, 2108, 2102, 2096, 2096, 2094, 2081, 2081, 2074, 2082, 2082, 2088, 2059, 2059, 2058, 2050, 2050, 2027, 2027, 2014, 2009, 2009, 1991, 1981, 1981, 1951, 1949, 1949, 1932, 1918, 1918, 1923, 1893, 1893, 1885, 1885, 1894, 1882, 1882, 1871, 1890, 1890, 1865, 1868, 1868, 1874, 1876, 1876, 1887, 1884, 1884, 1886, 1888, 1888, 1895, 1902, 1902, 1898, 1898, 1898, 1906, 1906, 1911, 1914, 1914, 1918, 1922, 1922, 1918, 1936, 1936, 1950, 1937, 1937, 1944, 1944, 1955, 1947, 1947, 1951, 1984, 1984, 1950, 1972, 1972, 1974, 1958, 1958, 1982, 1971, 1971, 1983, 1974, 1974, 1967, 1986, 1986, 1979, 1979, 1970, 1986, 1986, 1966, 1955, 1955, 1970, 1976, 1976, 1972, 1968, 1968, 1970, 1969, 1969, 1967, 1967, 1998, 1976, 1976, 1981, 1994, 1994, 1982, 1987, 1987, 1987, 1996, 1996, 1983, 1974, 1974, 1991, 1991, 1982, 1984, 1984, 2004, 1982, 1982, 1983, 2009, 2009, 1995, 1991, 1991, 2001, 2000, 2000, 1991, 1999, 1999, 2002, 1988, 1988, 1999, 1999, 1979, 2006, 2006, 2005, 1983, 1983, 1995, 1986, 1986, 1992, 2010, 2010, 1993, 2000, 2000, 1994, 1994, 1990, 2012, 2012, 1989, 1993, 1993, 1993, 1986, 1986, 1999, 1986, 1986, 2002, 1995, 1995, 1995, 1993, 1993, 2000, 2000, 1996, 1997, 1997, 1995, 1998, 1998, 1983, 1997, 1997, 1998, 1990, 1990, 1993, 1996, 1996, 1982, 1995, 1995, 2003, 2003, 2003, 1996, 1996, 1993, 1989, 1989, 2007, 2008, 2008, 2006, 2004, 2004, 1997, 2000, 2000, 2012, 2007, 2007, 2013, 2013, 2010, 2004, 2004, 2010, 2011, 2011, 2011, 2015, 2015, 2015, 2016, 2016, 2011, 2005, 2005, 2014, 2014, 2008, 1998, 1998, 2021, 2009, 2009, 2007, 2018, 1835, 1967, 1956, 1952, 1952, 1919, 1886, 1886, 1883, 1883, 1876, 1859, 1859, 1838, 1844, 1844, 1838, 1823, 1823, 1823, 1850, 1850, 1817, 1824, 1824, 1846, 1835, 1835, 1838, 1838, 1853, 1853, 1853, 1853, 1862, 1862, 1858, 1872, 1872, 1876, 1874, 1874, 1883, 1896, 1896, 1911, 1911, 1910, 1913, 1913, 1906, 1935, 1935, 1933, 1934, 1934, 1936, 1944, 1944, 1943, 1948, 1948, 1939, 1957, 1957, 1963, 1954, 1954, 1954, 1954, 1971, 1971, 1971, 1967, 1960, 1960, 1970, 1976, 1976, 1971, 1962, 1962, 1978, 1960, 1960, 1957, 1957, 1972, 1966, 1966, 1966, 1960, 1960, 1955, 1968, 1968, 1970, 1956, 1956, 1971, 1972, 1972, 1959, 1972, 1972, 1991, 1978, 1978, 1967, 1967, 1966, 1979, 1979, 1973, 1968, 1968, 1979, 1977, 1977, 1960, 1970, 1970, 1975, 1964, 1964, 1968, 1968, 1969, 1960, 1960, 1971, 1970, 1970, 1974, 1975, 1975, 1967, 1960, 1960, 1976, 1974, 1974, 1983, 1978, 1978, 1974, 1974, 1985, 1982, 1982, 1974, 1984, 1984, 1983, 1984, 1984, 1992, 1987, 1987, 1987, 1987, 1987, 1992, 1992, 1987, 1996, 1996, 1996, 1992, 1992, 1994, 1992, 1992, 2004, 2001, 2001, 2004, 1998, 1998, 1991, 2005, 2005, 2022, 2022, 2005, 2007, 2007, 2011, 2012, 2012, 2008, 2016, 2016, 2021, 2024, 2024, 2005, 2011, 2011, 2019, 2019, 2014, 2015, 2015, 2014, 1999, 1999, 2011, 2013, 2013, 1999, 2024, 2024, 2008, 1996, 1996, 2027, 2011, 2011, 2010, 2010, 2036, 2023, 2023, 2028, 2045, 2045, 2050, 2051, 2051, 2059, 2054, 2054, 2067, 2056, 2056, 2047, 2066, 2066, 2049, 2049, 2035, 2041, 2041, 2013, 2020, 2020, 2014, 1998, 1998, 1990, 1992, 1992, 1987, 1980, 1980, 1979, 1985, 1985, 1980, 1980, 1981, 1992, 1992, 1974, 1987, 1987, 1977, 1981, 1981, 1983, 1987, 1987, 2013, 2040, 2040, 2083, 2130, 2130, 2183, 2183, 2250, 2325, 2325, 2423, 2527, 2527, 2559, 2559, 2559, 2523, 2368, 2368, 2232, 2096, 2096, 2004, 2004, 1901, 1858, 1858, 1834, 1838, 1838, 1831, 1853, 1853, 1847, 1845, 1845, 1851, 1860, 1860, 1870, 1872, 1872, 1891, 1893, 1893, 1894, 1894, 1901, 1919, 1919, 1917, 1930, 1930, 1947, 1925, 1925, 1943, 1952, 1952, 1947, 1954, 1954, 1951, 1951, 1960, 1962, 1962, 1966, 1978, 1978, 1979, 1973, 1973, 1984, 1978, 1978, 1984, 1991, 1991, 1983, 1983, 1983, 1999, 1992, 1992, 1998, 1998, 1998, 2006, 2006, 1999, 2016, 2016, 2005, 2038, 2038, 2006, 2017, 2017, 2042, 2027, 2027, 2031, 2031, 2051, 2044, 2044, 2043, 2070, 2070, 2062, 2055, 2055, 2065, 2056, 2056, 2070, 2080, 2080, 2068, 2078, 2078, 2077, 2077, 2074, 2087, 2087, 2093, 2102, 2102, 2091, 2102, 2102, 2118, 2114, 2114, 2116, 2128, 2128, 2108, 2108, 2095, 2108, 2108, 2102, 2096, 2096, 2094, 2081, 2081, 2074, 2082, 2082, 2088, 2059, 2059, 2058, 2050, 2050, 2027, 2027, 2014, 2009, 2009, 1991, 1981, 1981, 1951, 1949, 1949, 1932, 1918, 1918, 1923, 1893, 1893, 1885, 1885, 1894, 1882, 1882, 1871, 1890, 1890, 1865, 1868, 1868, 1874, 1876, 1876, 1887, 1884, 1884, 1886, 1888, 1888, 1895, 1902, 1902, 1898, 1898, 1898, 1906, 1906, 1911, 1914, 1914, 1918, 1922, 1922, 1918, 1936, 1936, 1950, 1937, 1937, 1944, 1944, 1955, 1947, 1947, 1951, 1984, 1984, 1950, 1972, 1972, 1974, 1958, 1958, 1982, 1971, 1971, 1983, 1974, 1974, 1967, 1986, 1986, 1979, 1979, 1970, 1986, 1986, 1966, 1955, 1955, 1970, 1976, 1976, 1972, 1968, 1968, 1970, 1969, 1969, 1967, 1967, 1998, 1976, 1976, 1981, 1994, 1994, 1982, 1987, 1987, 1987, 1996, 1996, 1983, 1974, 1974, 1991, 1991, 1982, 1984, 1984, 2004, 1982, 1982, 1983, 2009, 2009, 1995, 1991, 1991, 2001, 2000, 2000, 1991, 1999, 1999, 2002, 1988, 1988, 1999, 1999, 1979, 2006, 2006, 2005, 1983, 1983, 1995, 1986, 1986, 1992, 2010, 2010, 1993, 2000, 2000, 1994, 1994, 1990, 2012, 2012, 1989, 1993, 1993, 1993, 1986, 1986, 1999, 1986, 1986, 2002, 1995, 1995, 1995, 1993, 1993, 2000, 2000, 1996, 1997, 1997, 1995, 1998, 1998, 1983, 1997, 1997, 1998, 1990, 1990, 1993, 1996, 1996, 1982, 1995, 1995, 2003, 2003, 2003, 1996, 1996, 1993, 1989, 1989, 2007, 2008, 2008, 2006, 2004, 2004, 1997, 2000, 2000, 2012, 2007, 2007, 2013, 2013, 2010, 2004, 2004, 2010, 2011, 2011, 2011, 2015, 2015, 2015, 2016, 2016, 2011, 2005, 2005, 2014, 2014, 2008, 1998, 1998, 2021, 2009, 2009, 2007, 2018];


        var chart = new CanvasJS.Chart("graph",
            {
                title: {
                    text: "ECG Report",
                },
                subtitles: [{
                    text: "Patient Name: Patient Name",
                    horizontalAlign: "left",
                },
                    {
                        text: "Age: X-Years",
                        horizontalAlign: "left",
                    },
                    {
                        text: "Doctor Sign",
                        horizontalAlign: "right",
                        verticalAlign: "bottom",
                    },
                ],
                axisY: {
                    stripLines: yAxisStripLinesArray,
                    gridThickness: 2,
                    gridColor: "#DC74A5",
                    lineColor: "#DC74A5",
                    tickColor: "#DC74A5",
                    labelFontColor: "#DC74A5",
                },
                axisX: {
                    stripLines: xAxisStripLinesArray,
                    gridThickness: 2,
                    gridColor: "#DC74A5",
                    lineColor: "#DC74A5",
                    tickColor: "#DC74A5",
                    labelFontColor: "#DC74A5",
                },
                data: [
                    {
                        type: "spline",
                        color: "black",
                        dataPoints: dps
                    }
                ]
            });

        addDataPointsAndStripLines();
        chart.render();

        function addDataPointsAndStripLines() {
            //dataPoints
            for (var i = 0; i < dataPointsArray.length; i++) {
                dps.push({y: dataPointsArray[i]});
            }
            //StripLines
            for (var i = 0; i < 3000; i = i + 100) {
                if (i % 1000 != 0)
                    yAxisStripLinesArray.push({value: i, thickness: 0.7, color: "#DC74A5"});
            }
            for (var i = 0; i < 1400; i = i + 20) {
                if (i % 200 != 0)
                    xAxisStripLinesArray.push({value: i, thickness: 0.7, color: "#DC74A5"});
            }
        }

    }

    // const requestURL = '/leads/100'
    // sendRequest('GET', requestURL)
    //     .then(d => {
    //         drawLeads({"test": "here"}, d)
    //     })
    //     .catch(err => {
    //             console.log(err)
    //         }
    //     )


    function drawSingleLead(lead, containerName, singleLeadData) {
        var xAxisStripLinesArray = [];
        var yAxisStripLinesArray = [];
        var dps = [];
        var dataPointsArray = singleLeadData.data;

        var chart = new CanvasJS.Chart(containerName, {
            height: 200,
            zoomEnabled: true,
            animationEnabled: true,
            showInLegend: true,
            // title: {
            //     text: "ECG Report",
            // },
            subtitles: [{
                text: "Lead " + lead,
                horizontalAlign: "left",
            }],
            //     {
            //         text: "Age: X-Years",
            //         horizontalAlign: "left",
            //     },
            //     {
            //         text: "Doctor Sign",
            //         horizontalAlign: "right",
            //         verticalAlign: "bottom",
            //     },
            // ],
            axisY: {
                stripLines: yAxisStripLinesArray,
                gridThickness: 2,
                gridColor: "#DC74A5",
                lineColor: "#DC74A5",
                tickColor: "#DC74A5",
                labelFontColor: "#DC74A5",
            },
            axisX: {
                stripLines: xAxisStripLinesArray,
                gridThickness: 2,
                gridColor: "#DC74A5",
                lineColor: "#DC74A5",
                tickColor: "#DC74A5",
                labelFontColor: "#DC74A5",
            },
            data: [{
                type: "spline",
                color: "black",
                dataPoints: dps
            }]
        });

        addDataPointsAndStripLines();
        chart.render();

        function addDataPointsAndStripLines() {
            //dataPoints
            for (var i = 0; i < dataPointsArray.length; i++) {
                dps.push({
                    y: dataPointsArray[i]
                });
            }
            //StripLines
            for (var i = 0; i < 5000; i = i + 100) {
                // if (i % 1000 != 0)
                yAxisStripLinesArray.push({
                    value: i,
                    thickness: 0.7,
                    color: "#DC74A5"
                });
            }
            for (var i = 0; i < 5000; i += 20) {
                // if (i % 200 != 0)
                xAxisStripLinesArray.push({
                    value: i,
                    thickness: 0.7,
                    color: "#DC74A5"
                });
            }
        }
    }

</script>
</body>
</html>