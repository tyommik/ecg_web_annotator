<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ECG Annotation Tool</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="/static/js/canvasjs.min.js"></script>

    <link rel="stylesheet" href="//cdn.webix.com/edge/webix.css" type="text/css">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>
</head>
<body>

<script type="text/javascript" charset="utf-8">
    function sendRequest(method, url) {
        return fetch(url).then(response => {
            return response.json()
        })
    }

    var header = {
            id: "header",
            css: "header",
            template: "<div id='header'>EKG annotation tool</div>",
            height: 50
        }

    webix.ready(() => {
        webix.ui({
            id: "app",
            rows: [
                header,
                {
                    cols: [
                        {
                            gravity: 3, rows: [
                                {
                                    id: "drawLayout",
                                    align: "center,middle",
                                    template:'<div id="graph"></div>',
                                    scroll: true,
                                    width:0,
                                    // height:800,
                                    // rows: [],
                                },
                                // { view:"resizer"},
                                {
                                    rows: [

                                        {
                                            view: "form",
                                            scroll: false,
                                            elements: [],
                                            id: "form_tipos",
                                            height: 300,
                                        },
                                        {
                                            margin: 5, cols: [
                                                {
                                                    id: "saveBtn",
                                                    view: "button",
                                                    label: "Save",
                                                    disabled: true,
                                                    type: "form",
                                                    click: () => {
                                                        var form = $$("form_tipos");
                                                        data = getForm(form);
                                                        if (data) {
                                                            // if (form.validate()) {
                                                            webix.ajax().post("/anno/100", data, function (res) {
                                                                webix.message('Saved')
                                                            });
                                                        }
                                                    }
                                                },
                                                {id: "cancelBtn", view: "button", disabled:true, label: "Cancel", click: () => {alert('Clean Stub')}}
                                            ]
                                        }

                                    ]
                                },
                            ]
                        },
                        {
                            // container: "ecglist",
                            rows: [
                                {
                                    cols: [
                                        {
                                            header: "Список ЭКГ", body:
                                                {
                                                    view: "list",
                                                    template: "#rank#. #title#",
                                                    url: "/getlist",
                                                    select: true,
                                                    ready: function(){
                                                        if (this.count() <= 1) {
                                                            webix.extend(this, webix.OverlayBox);
                                                            this.showOverlay("<div style='margin:75px; font-size:20px;'>There is no data</div>");
                                                        } else {

                                                        }
                                                    },
                                                    on: {
                                                        // the default click behavior that is true for any datatable cell
                                                        "onItemClick": function (id, e, trg) {
                                                            show_progress_bar(2000)
                                                            requestData(id)
                                                        }
                                                    },
                                                }
                                        },

                                    ]
                                },
                                {
                                    id: "sendButton",
                                    view: "button",
                                    value: "Cancel",
                                    label: "Send"
                                },
                            ]
                        },
                    ]
                },
                {align: "center,middle", template: "<div id='footer'>Stream Labs 2020</div>", height: 50}
            ]
        })
    });
    
    //adding ProgressBar functionality to layout
    // webix.extend($$("app"), webix.ProgressBar)

    function show_progress_bar(delay) {
        webix.extend($$("app"), webix.ProgressBar)
        $$("app").disable();
        $$("app").showProgress({
            type: "icon",
            delay: delay,
            hide: true
        });
        setTimeout(function () {
            $$("app").enable();
        }, delay);
    }

    function getForm(form) {
        let values = form.getChildViews()
        let response = []
        for (let i = 0; i < values.length; i++) {
            let block = values[i].getValues()
            response.push(block)
        }
        return JSON.stringify(response)
    }

    function requestData(id) {
        $$("saveBtn").enable()
        $$("cancelBtn").enable()
        requestLeadData(id)
        requestReportDate(id)
    }

    function requestReportDate(id) {
        const requestURL = '/anno/' + id
        sendRequest('GET', requestURL)
            .then(data => {
                rebuildForm(data)
            })
            .catch(err => {
                    webix.message(err)
                }
            )
    }

    function requestLeadData(id) {
        const requestURL = '/leads/' + id
        sendRequest('GET', requestURL)
            .then(data => {
                // drawOnLayout(data)
                drawLeads({}, data)
                // getData()
            })
            .catch(err => {
                    webix.message(err)
                }
            )
    }

    function rebuildForm(data, clean=false) {
        data = data.data
        let checkbox = []
        for (i = 0; i < data.length; i++) {
            let group = []
            group.push({ template:data[i]["group_label"], type:"section"})
            let group_array = data[i]["group_data"]
            for (j = 0; j < group_array.length; j++) {
                group.push({
                    view: "checkbox",
                    align: "left",
                    label: group_array[j].label,
                    name: group_array[j].name,
                    value: (clean) ? 0 : group_array[j].value,
                })
            }
            // checkbox.push({rows: group})
            checkbox.push({
                view: "form",
                elements: group,
                margin: 2,
                elementsConfig: {"labelAlign": "left", labelWidth:350}
            })
        }
        webix.ui({
                view: "form",
                scroll: false,
                id: 'form_tipos',
                cols: checkbox
            }
            , $$('form_tipos'));
        // this.disable();
    }

    function drawOnLayout(data) {
        webix.ui({
            align: "center,middle",
            // template:'<button class="btn-back" id="button" style="visibility:visible">&#8634;</button><div id="graph"></div>',
            body: {
                view: "label",
                label: "<div id='warnstyle'>Select item from list</div>",
                align: "center"
            }
        }, $$('drawLayout'));
    }

    function drawLeads(params, data) {

        let NUM_LEADS = 12

        data = data.data
        const myNode = document.getElementById("graph");
        while (myNode.lastElementChild) {
            myNode.removeChild(myNode.lastElementChild);
        }

        for (let i = 0; i < NUM_LEADS; i++) {
            var div = document.createElement('div')
            div.className = "chart"
            div.id = "chartContainer" + i
            div.style = "position: relative; width: 100%; height: 200px;display: inline-block;"
            document.getElementById('graph').appendChild(div)
            drawSingleLead(i, 'chartContainer' + i, data[i])
        }

    }

    function drawSingleLead(lead, containerName, singleLeadData) {
        let leadNames = {
            0: "I",
            1: "II",
            2: "III",
            3: "aVR",
            4: "aVL",
            5: "aVF",
            6: "V1",
            7: "V2",
            8: "V3",
            9: "V4",
            10: "V5",
            11: "V6"
        }

        var xAxisStripLinesArray = [];
        var yAxisStripLinesArray = [];
        var dps = [];
        var dataPointsArray = singleLeadData;

        var chart = new CanvasJS.Chart(containerName, {
            height: 200,
            zoomEnabled: true,
            animationEnabled: true,
            animationDuration: 2000,
            showInLegend: true,
            // title: {
            //     text: lead,
            // },
            subtitles: [{
                fontSize:15,
                text: "Lead " + leadNames[lead],
                horizontalAlign: "left",
            }],
            axisY: {
                stripLines: yAxisStripLinesArray,
                gridThickness: 2,
                gridColor: "#DC74A5",
                lineColor: "#DC74A5",
                tickColor: "#DC74A5",
                labelFontColor: "#DC74A5",
            },
            axisX: {
                stripLines: xAxisStripLinesArray,
                gridThickness: 2,
                gridColor: "#DC74A5",
                lineColor: "#DC74A5",
                tickColor: "#DC74A5",
                labelFontColor: "#DC74A5",
            },
            data: [{
                type: "spline",
                color: "black",
                dataPoints: dps
            }]
        });

        addDataPointsAndStripLines();
        chart.render();


        function addDataPointsAndStripLines() {
            //dataPoints
            for (var i = 0; i < dataPointsArray.length; i++) {
                dps.push({
                    y: dataPointsArray[i]
                });
            }
            //StripLines
            for (var i = 0; i < 5000; i = i + 100) {
                // if (i % 1000 != 0)
                yAxisStripLinesArray.push({
                    value: i,
                    thickness: 0.7,
                    color: "#DC74A5"
                });
            }
            for (var i = 0; i < 5000; i += 20) {
                // if (i % 200 != 0)
                xAxisStripLinesArray.push({
                    value: i,
                    thickness: 0.7,
                    color: "#DC74A5"
                });
            }
        }
    }

</script>
</body>
</html>
